# Безопасность в Yandex Cloud
<p><strong>Task:</strong><br />В целях безопасности облачных ресурсов реализовал права на управление сервисным аккаунтом, организовал защищённый канал настроив IPSec VPN-туннель между двумя VPN-шлюзами в ВМ с помощью демона strongSwan, реализовал для домена втоматический выпуск сертификата с помощью Certificate Manager<br /><strong>Task:</strong><br />Права доступа и роли для сервисного аккаунта.<br />В этом уроке вы научитесь работать с сервисными аккаунтами и назначать для них роли и права доступа к объектам. <br />В качестве объекта будет выступать созданный в сервисе KMS ключ шифрования. <br />Предположим, что перед вами стоит задача использовать сервисный аккаунт для ротации ключей.<br />Чтобы решить эту задачу, понадобится выполнить следующие шаги:<br />- Создать сервисный аккаунт.<br />- Получить права на управление этим сервисным аккаунтом.<br />- Создать статические ключи доступа и привязать их к сервисному аккаунту, чтобы он мог пройти авторизацию в сервисе KMS.<br />- Создать в сервисе KMS ключ шифрования и назначить сервисному аккаунту роль kms.admin для управления этим ключом.<br />- И, наконец, ротировать ключ, то есть создать его новую версию с такими же параметрами, из-под сервисного аккаунта.<br />- Нужно заметить, что через консоль управления сервисному аккаунту можно назначить роль только на каталог, в котором он был создан. Роли на все остальные ресурсы назначаются с помощью CLI или API. Поэтому для выполнения этой практической работы вам понадобится вспомнить, как пользоваться утилитой yc, чему вы уже научились в курсе &laquo;DevOps и автоматизация&raquo;.<br /><strong>Decision:</strong><br />ШАГ 1<br />Для начала создадим сервисный аккаунт. В консоли управления войдите в каталог облака, в котором вы будете выполнять эту практическую работу, и перейдите на вкладку Сервисные аккаунты. Нажмите кнопку Создать сервисный аккаунт.<br />В открывшемся окне задайте для нового сервисного аккаунта имя и, при желании, добавьте описание. Здесь аккаунту также можно добавить роли на каталог, в котором он создаётся.<br />Оставьте поле с ролями пустым и нажмите Создать.<br />ШАГ 2<br />Настройте для вашего аккаунта на Яндексе доступ на авторизацию под созданным сервисным аккаунтом.<br />Для начала убедитесь, что вы авторизованы в аккаунте с ролью admin. Чтобы это проверить, выполните команду<br />yc iam role list <br />Вы увидите список ролей вашего аккаунта. Примерно такой (роль admin должна в нем присутствовать):<br />Узнайте идентификатор своего аккаунта. Он понадобится, чтобы добавить вашему аккаунту роль editor на созданный сервисный аккаунт (сервисный аккаунт тоже является ресурсом, и для работы с ним нужна соответствующая роль). Воспользуйтесь для этого командой:<br />yc iam user-account get &lt;имя_вашего_аккаунта&gt; <br />Кроме того, нужно узнать идентификатор созданного сервисного аккаунта. Это можно сделать в разделе Сервисные аккаунты консоли управления. Выбрав нужный аккаунт в списке, вы перейдёте на страницу с детальной информацией о нем.<br />Теперь предоставьте вашему пользовательскому аккаунту права на управление созданным сервисным аккаунтом. Для этого нужно выполнить команду<br />yc iam service-account add-access-binding &lt;ID_сервисного_аккаунта&gt; \<br />--role editor --subject userAccount:&lt;ID_пользовательского_аккаунта&gt; <br />ШАГ 3<br />Настройте аутентификацию под сервисным аккаунтом с вашей машины.<br />Сначала нужно создать статические ключи доступа и сохранить их в json-файле (например key.json).<br />Воспользуйтесь для этого командой<br />yc --folder-name &lt;имя_каталога&gt; iam key create \<br />--service-account-name &lt;имя_сервисного_аккаунта&gt; --output key.json <br />После выполнения команды вы получите идентификатор созданной ключевой пары. Используя статические ключи доступа, можно получить IAM-токен для авторизации в сервисах.<br />Теперь нужно создать профиль, от имени которого будут выполняться операции из-под сервисного аккаунта. Для этого придумайте имя этого профиля (например yc-lab23-profile) и выполните команду:<br />yc config profile create &lt;имя_профиля&gt; <br />Привяжите к этому профилю ранее созданный статический ключ доступа с помощью команды:<br />yc config set service-account-key key.json <br />Чтобы убедиться, что всё сделано правильно, выведите информацию об авторизации и ключах доступа<br />yc config list <br />Вы должны получить примерно такой результат:<br />ШАГ 4<br />Теперь нужно создать ключ шифрования, ротацией которого вы будете управлять с помощью сервисного аккаунта. Для этого перейдите в дашборд каталога в консоли управления, нажмите кнопку Создать ресурс и выберите Ключ шифрования.<br />В открывшемся окне задайте для ключа имя и нажмите кнопку Создать. Новый ключ появится в списке в открывшемся разделе Ключи.<br />Чтобы назначить сервисному аккаунту роль для какого-либо ресурса, нужно знать идентификатор этого ресурса. Нажмите строку с созданным ключом, чтобы перейти на страницу детальной информации о нём, и скопируйте ID ключа.<br />Перейдем к назначению сервисному аккаунту роли kms.admin для управления созданным ключом шифрования. Перед этим нужно сначала вернуться в профиль вашего аккаунта.<br />yc config profile activate &lt;имя_профиля&gt; <br />Выполните команду:<br />yc --folder-name &lt;имя_каталога&gt; kms symmetric-key \<br />add-access-binding &lt;ID_ключа_шифрования&gt; --role kms.admin \<br />--subject serviceAccount:&lt;ID_сервисного_аккаунта&gt; <br />Теперь с помощью сервисного аккаунта вы можете управлять этим ключом шифрования.<br />ШАГ 5<br />В CLI переключитесь обратно в профиль сервисного аккаунта:<br />yc config profile activate &lt;имя_профиля_сервисного_аккаунта&gt; <br />Ротируйте ключ шифрования:<br />yc kms symmetric-key rotate &lt;ID_ключа&gt; <br />После выполнения команды перейдите на страницу детальной информации о ключе и откройте вкладку Операции.<br />Вы увидите, что операция по ротации ключа выполнена под вашим сервисным аккаунтом. Значит, всё получилось и задача решена!<br /><strong>Decision:</strong><br />$ yc iam service-account create --name &lt;имя_сервисного_аккаунта&gt;<br />$ yc iam service-account create --name security-labs \<br />--description "Service account for Security course labs"<br />$ yc iam role list<br />$ yc iam user-account get &lt;ваш_логин&gt;<br />$ yc iam service-account list<br />$ yc iam service-account get &lt;имя_сервисного_аккаунта&gt;<br />$ yc iam service-account add-access-binding &lt;id_сервисного_аккаунта&gt; \<br />--role editor \<br />--subject userAccount:&lt;id_пользовательского_аккаунта&gt;<br />$ vim key.json<br />$ cat key.json<br />{<br />&nbsp; "id": "YOUR-ID1",<br />&nbsp; "service_account_id": "YOUR-ID2",<br />&nbsp; "created_at": "2023-12-09T01:19:35.625144946Z",<br />&nbsp; "key_algorithm": "RSA_2048",<br />&nbsp; "public_key": "-----BEGIN PUBLIC KEY-----\nYOUR-KEY1\n-----END PUBLIC KEY-----\n",<br />&nbsp; "private_key": "PLEASE DO NOT REMOVE THIS LINE! Yandex.Cloud SA Key ID &lt;YOUR-ID1&gt;\n-----BEGIN PRIVATE KEY-----\nYOUR-KEY2\n-----END PRIVATE KEY-----\n"<br />}<br />$ yc iam key create \<br />--service-account-name &lt;имя_сервисного_аккаунта&gt; \<br />--output key.json<br />$ yc config profile create &lt;имя_профиля_сервисного_аккаунта&gt;<br />$ yc config set service-account-key key.json<br />$ yc config set folder-id &lt;идентификатор_рабочего_каталога&gt;<br />$ yc config list<br />$ yc config profile list<br />$ yc config profile activate &lt;имя_основного_профиля&gt;<br />$ yc kms symmetric-key add-access-binding \<br />--id &lt;id_ключа_шифрования&gt; \<br />--role kms.admin \<br />--subject serviceAccount:&lt;id_сервисного_аккаунта&gt;<br />$ yc config profile activate &lt;имя_профиля_сервисного_аккаунта&gt;<br />$ yc kms symmetric-key rotate --id &lt;id_ключа_шифрования&gt;<br /><strong>Task:</strong><br />Организация защищённого канала. <br />Защита данных, передаваемых между вашей локальной инфраструктурой и облаком, &mdash; важный элемент информационной безопасности. А удалённая работа, которая получила распространение в период пандемии коронавируса и сейчас закрепилась в практиках многих компаний, сделала эту задачу ещё более актуальной.<br />Чтобы защитить передаваемую информацию, используют VPN (Virtual Private Network) &mdash; технологию, позволяющую развернуть защищённое сетевое соединение &laquo;поверх&raquo; незащищённой сети (чаще всего это интернет). VPN-соединение представляет собой канал передачи данных между двумя узлами. Этот канал обычно называют VPN-туннелем. Если за одним из узлов находится целая сеть, то его называют VPN-шлюзом.<br />Механизм работы VPN:<br />- Перед созданием туннеля узлы идентифицируют друг друга, чтобы удостовериться, что шифрованные данные будут отправлены на нужный узел.<br />- На обоих узлах нужно заранее определить, какие протоколы будут использоваться для шифрования и обеспечения целостности данных.<br />- Узлы сверяют настройки, чтобы договориться об используемых алгоритмах. Если настройки разные, туннель не создаётся.<br />- Если сверка прошла успешно, то создаётся ключ, который используется для симметричного шифрования.<br />Этот механизм регламентируют несколько стандартов. Один из самых популярных &mdash; IPSec (Internet Protocol Security).<br />На этом уроке вы научитесь настраивать IPSec VPN-туннель между двумя VPN-шлюзами с помощью демона strongSwan. Один шлюз вы настроите на виртуальной машине в Yandex Cloud, второй &mdash; на своей локальной машине или виртуальной машине в другой облачной сети.<br /><strong>Decision:</strong><br />Шаг 1. Создание ресурсов<br />Для практической работы вам понадобится сеть и подсеть в Yandex Cloud, а также созданная в этой подсети тестовая ВМ без публичного IP-адреса. Создайте эти ресурсы, если у вас их нет.<br />Теперь создадим IPSec-инстанс &mdash; ВМ, которая будет служить шлюзом для IPSec-туннеля. Чтобы это сделать:<br />Откройте ваш каталог, нажмите кнопку Создать ресурс и выберите пункт Виртуальная машина.<br />В поле Имя задайте имя ВМ, например ipsec-instance.<br />Выберите зону доступности, где находится подсеть, к которой будет подключён IPSec-инстанс, и тестовая ВМ.<br />В разделе Выбор образа/загрузочного диска перейдите в блок Cloud Marketplace и выберите образ IPSec-инстанс.<br />В блоке Сетевые настройки выберите нужную сеть, подсеть и назначьте ВМ публичный IP-адрес из списка или автоматически.<br />Важно использовать только статические публичные IP-адреса из списка или сделать IP-адрес ВМ статическим после её создания. Динамический IP-адрес может измениться после перезагрузки ВМ, и туннель перестанет работать.<br />В блоке Доступ укажите логин и SSH-ключ для доступа к ВМ.<br />Нажмите кнопку Создать ВМ.<br />Виртуальная машина готова.<br />Шаг 2. Настраиваем IPSec<br />Теперь настроим шлюз с публичным IP-адресом, который будет устанавливать IPSec-соединение с удалённым шлюзом (вашей локальной машиной или ВМ в другой облачной сети).<br />Вы можете создать в своём каталоге ещё одну облачную сеть с подсетью, создать в ней IPSec-инстанс из образа и использовать его в качестве удалённого шлюза. Либо можно использовать в качестве шлюза машину в вашей локальной сети. Вам понадобится публичный IP-адрес удалённого шлюза и CIDR подсети.<br />Допустим, публичный IP-адрес вашего шлюза &mdash; 130.193.32.25, а за ним находится подсеть c префиксом подсети CIDR 10.128.0.0/24. Шлюз будет устанавливать IPSec-соединение с удалённым шлюзом с IP-адресом, например, 1.1.1.1, за которым находится подсеть с префиксом подсети CIDR 192.168.0.0/24.<br />Подключитесь к ВМ IPSec-инстанс по SSH:<br />ssh &lt;имя пользователя&gt;@130.193.32.25 <br />Откройте конфигурацию IPSec:<br />sudo nano /etc/ipsec.conf <br />В разделе config setup файла конфигурации задайте следующие параметры:<br />config setup<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charondebug="all"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uniqueids=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strictcrlpolicy=no <br />Добавьте новый раздел с описанием тестового соединения, например conn cloud-to-hq.<br />Задайте параметры тестового соединения:<br />leftid &mdash; публичный IP-адрес IPSec-инстанса.<br />leftsubnet &mdash; CIDR подсети, к которой подключён IPSec-инстанс.<br />right &mdash; публичный IP-адрес шлюза на другом конце VPN-туннеля.<br />rightsubnet &mdash; CIDR подсети, к которой подключён VPN-шлюз на другом конце VPN-туннеля.<br />Параметры ike и esp &mdash; это алгоритмы шифрования, которые поддерживаются на удалённом шлюзе. Перечень поддерживаемых алгоритмов можно посмотреть на сайте strongSwan: IKEv1 и IKEv2.<br />Укажите остальные настройки, консультируясь с документацией strongSwan и учитывая настройки удалённого шлюза.<br />У вас должна получиться примерно такая конфигурация:<br />conn cloud-to-hq<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start <br />Сохраните изменения и закройте файл.<br />Откройте файл /etc/ipsec.secrets и укажите в нём пароль для установки соединения:<br />130.193.32.25 1.1.1.1 : PSK "&lt;пароль&gt;" <br />Перезапустите strongSwan:<br />sudo systemctl restart strongswan-starter <br />Шаг 3. Настраиваем статическую маршрутизацию<br />Теперь нужно настроить маршрутизацию между IPSec-инстансом и тестовой ВМ без публичного IP-адреса. Для этого создадим таблицу маршрутизации и добавим в неё статические маршруты.<br />Откройте сервис Virtual Private Cloud в каталоге, где требуется создать статический маршрут.<br />Выберите раздел Таблицы маршрутизации в панели слева и нажмите кнопку Создать таблицу маршрутизации.<br />Задайте имя таблицы маршрутизации, выберите сеть, в которой требуется её создать, и нажмите кнопку Добавить маршрут.<br />В открывшемся окне введите префикс подсети назначения на удалённой стороне, в примере это 192.168.0.0/24.<br />В поле Next hop укажите внутренний IP-адрес IPSec-шлюза и нажмите кнопку Добавить.<br />Нажмите кнопку Создать таблицу маршрутизации.<br />Чтобы использовать статические маршруты, нужно привязать таблицу маршрутизации к подсети. Для этого в разделе Подсети, в строке нужной подсети, нажмите кнопку &hellip; и в открывшемся меню выберите пункт Привязать таблицу маршрутизации.<br />В открывшемся окне выберите созданную таблицу и нажмите кнопку Привязать. Созданный маршрут можно применять и к другим подсетям этой сети.<br />Шаг 4. Настраиваем IPSec на другом шлюзе<br />Для работы VPN-туннеля нужно настроить второй шлюз.<br />Настройте strongSwan аналогично первому IPSec-шлюзу, но с зеркальными настройками IP-адресов и подсетей в файле /etc/ipsec.conf. Должна получиться такая конфигурация:<br />conn hq-to-cloud<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start <br />Укажите пароль для соединения в файле /etc/ipsec.secrets, указав IP-адреса шлюзов в обратном порядке:<br />1.1.1.1 130.193.32.25 : PSK "&lt;пароль&gt;" <br />Перезапустите strongSwan:<br />sudo systemctl restart strongswan-starter <br />Шаг 5. Проверяем, что всё работает<br />Чтобы убедиться, что туннель между шлюзами установлен, выполните на любом из шлюзов команду:<br />sudo ipsec status <br />Если всё в порядке, то у вас должно появиться примерно такое сообщение:<br />Security Associations (1 up, 0 connecting):<br />hq-to-cloud[3]: ESTABLISHED 29 minutes ago, 10.128.0.26[130.193.33.12]...192.168.0.23[1.1.1.1]<br />hq-to-cloud{3}:&nbsp; INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c7fa371d_i ce8b91ad_o<br />hq-to-cloud{3}:&nbsp;&nbsp; 10.128.0.0/24 === 192.168.0.0/24 <br />Статус ESTABLISHED означает, что туннель между шлюзами создан.<br />Сведения об установке и работе соединения находятся в логах strongSwan. Просмотреть логи можно с помощью команды:<br />sudo journalctl -u strongswan-starter <br />Проверить статус демона strongSwan можно командой:<br />systemctl status strongswan-starter <br />Осталось проверить связность соединения. Для этого создайте ещё одну тестовую виртуальную машину за вторым шлюзом, а затем пропингуйте одну тестовую машину с другой.<br /><strong>Decision:</strong><br />$ ssh &lt;имя пользователя&gt;@130.193.32.25<br />$ sudo vim /etc/ipsec.conf<br />$ sudo cat /etc/ipsec.conf<br />...<br />config setup<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charondebug="all"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uniqueids=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strictcrlpolicy=no<br />...<br />conn cloud-to-hq<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start<br />$ sudo vim /etc/ipsec.secrets<br />$ sudo cat /etc/ipsec.secrets<br />130.193.32.25 1.1.1.1 : PSK "&lt;пароль&gt;"<br />$ sudo systemctl restart strongswan-starter<br />$ exit <br />$ ssh &lt;имя пользователя&gt;@130.193.32.26<br />$ sudo vim /etc/ipsec.conf<br />$ sudo cat /etc/ipsec.conf<br />...<br />config setup<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charondebug="all"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uniqueids=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strictcrlpolicy=no<br />...<br />conn hq-to-cloud<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start<br />$ sudo vim /etc/ipsec.secrets<br />$ sudo cat /etc/ipsec.secrets<br />1.1.1.1 130.193.32.25 : PSK "&lt;пароль&gt;"<br />$ sudo systemctl restart strongswan-starter<br />$ ssh &lt;имя пользователя&gt;@130.193.32.25<br />$ sudo ipsec status <br />$ sudo journalctl -u strongswan-starter<br />$ systemctl status strongswan-starter<br /><strong>Task:</strong><br />Выпуск сертификата для сайта.<br />В этой практической работе мы зарегистрируем домен, привяжем его к бакету в объектном хранилище и настроим для этого домена автоматический выпуск сертификата с помощью Certificate Manager.<br /><strong>Decision:</strong><br />Шаг 1<br />Если у вас нет своего домена, зарегистрируйте временный домен, например, на сайте freenom.com:<br />Проверьте на сайте доступность имени, которое вы придумали для своего домена.<br />Введите имя вместе с доменом верхнего уровня, например testpracticum2022.ml, иначе при попытке зарезервировать домен сервис будет сообщать, что домен занят.<br />Если это имя доступно, добавьте домен в корзину и укажите свой email для подтверждения.<br />Проверьте почту и подтвердите регистрацию домена.<br />Обновите страницу с заказом.<br />После подтверждения регистрации домена зайдите в объектное хранилище (Object Storage) и создайте новый публичный бакет. Его название должно совпадать с полным названием домена.<br />Переключите доступ на чтение объектов в Публичный. Загрузите в бакет файлы статического сайта (вы можете воспользоваться файлами из практической работы курса &laquo;Хранение и анализ данных&raquo;.<br />Выберите на панели управления раздел Веб-сайт, переключите бакет в режим Хостинг и нажмите Сохранить.<br />Шаг 2<br />Настроить защищённый доступ к бакету можно двумя способами: загрузить сертификат прямо в бакет или с помощью Certificate Manager. Воспользуемся вторым способом.<br />В консоли управления перейдите в сервис Certificate Manager. Для выпуска сертификата с помощью этого сервиса подтвердите владение доменом: в разделе Сертификаты нажмите кнопку Добавить сертификат и выберите Сертификат Let&rsquo;s Encrypt.<br />В открывшемся окне задайте имя создаваемого сертификата и заполните поле с именем вашего домена. Нажмите кнопку Создать.<br />Сервис автоматически направит запрос на создание сертификата, а домен перейдёт в статус проверки.<br />Для выпуска сертификата необходимо подтвердить статус владения доменом. Откройте страницу с деталями запроса на сертификат:<br />На этой странице для нас важны два поля: имя DNS-записи и её значение. Если вы создавали домен на freenom.com, то перейдите в личный кабинет на этом сайте, выберите раздел Services &rarr; My Domains и нажмите кнопку Manage Domains:<br />Выберите Manage Freenom DNS:<br />В открывшемся редакторе добавьте TXT-запись для подтверждения владения доменом. В качестве названия записи задайте _acme-challenge без полного названия домена. В качестве значения TXT-записи &mdash; значение со страницы проверки прав на домен в консоли управления Yandex Cloud.<br />Аналогично внесите значение CNAME-записи со страницы проверки прав на домен в консоли управления Yandex Cloud.<br />Добавьте также запись CNAME для привязки поддомена WWW к вашему бакету:<br />В поле Target укажите полное имя бакета, включая .website.yandexcloud.net. Сохраните сделанные изменения.<br />Если вы используете собственный домен, задайте параметры DNS в настройках вашего DNS-сервера. Для применения настроек DNS потребуется некоторое время &mdash; обычно до 15 минут.<br />После окончания проверки домена Certificate Manager автоматически выпустит сертификат.<br />Шаг 3<br />Теперь настроим доступ к сайту, то есть к созданному бакету, по протоколу HTTPS с помощью сертификата. Для этого перейдите в раздел HTTPS и нажмите кнопку Настроить.<br />В поле Источник выберите Certificate Manager, в поле Сертификат &mdash; ранее выпущенный сертификат. Нажмите кнопку Сохранить.<br />Теперь ваш сайт доступен по протоколу HTTPS. Чтобы проверить это, откройте его в браузере. В адресной строке браузера должен отображаться значок защищённого соединения.<br /><strong>Task:</strong><br />Создание и ротация ключей шифрования<br />На прошлом уроке вы познакомились с возможностями сервиса управления ключами шифрования KMS. В этой практической работе вы научитесь создавать ключи шифрования и управлять ими, а также использовать эти ключи для шифрования и расшифрования данных.<br /><strong>Decision:</strong><br />Шаг 1<br />Перейдите в панель управления Yandex Cloud, нажмите кнопку Создать ресурс и выберите из выпадающего списка пункт Ключ шифрования.<br />Задайте для создаваемого ключа имя (например yc-lab-key1), заполните поле Описание (это необязательно) и выберите алгоритм шифрования. Предположим, что ключ нужно ротировать каждый день. Для этого в поле Период ротации, дни выберите вариант Своё значение и введите число 1 в поле справа.<br />Нажмите кнопку Создать. Когда операция создания ключа завершится, новый ключ появится в списке.<br />Нажав на строку с ключом, вы перейдёте на страницу детальной информации. На ней приведены все параметры ключа, а также список его версий. Обратите внимание, что ID (идентификатор) ключа и ID конкретной версии ключа отличаются. Важно их не путать.<br />Шаг 2<br />Давайте используем созданный ключ для шифрования и расшифрования данных. Создайте у себя на диске файл (например, текстовый файл с именем plain.txt). Добавьте в него любой текст и сохраните содержимое. Напомним, что размер файла не должен превышать 32 килобайта.<br />Запустите утилиту командной строки (bash или cmd) и перейдите в каталог с файлом plain.txt. Зашифруйте этот файл с помощью утилиты yc, а результат операции шифрования выведите в файл encrypted.txt. Для этого выполните команду:<br />yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted.txt <br />После выполнения команды будет создан файл encrypted.txt, который содержит зашифрованный текст. Утилита yc также выведет информацию о том, каким ключом и какой его версией файл был зашифрован.<br />Шаг 3<br />Теперь расшифруйте этот файл, а результат операции выведите в файл decrypted.txt. Для этого выполните команду:<br />yc kms symmetric-crypto decrypt --id &lt;ID ключа&gt; --ciphertext-file encrypted.txt --plaintext-file decrypted.txt <br />В результате выполнения команды будет создан файл decrypted.txt с идентичным исходному файлу (plain.txt) содержимым.<br />Если расшифровать файл не удалось, утилита выдаст сообщение об ошибке.<br />Шаг 4<br />Создайте новую версию ключа. Для этого перейдите на страницу детальной информации о ключе и нажмите кнопку Ротировать. Новая версия ключа появится в списке версий и станет основной (Primary). Обратите внимание, что идентификаторы версий отличаются друг от друга.<br />Шаг 5<br />Запланируйте удаление первой версии ключа. Для этого в списке версий нажмите на значок &hellip; в строке с этой версией, а затем выберите пункт Запланировать удаление.<br />В появившемся окне установите время, по истечении которого ключ будет удалён, и нажмите Запланировать. Версия ключа не может быть удалена моментально, минимальный период времени для её удаления составляет один день.<br />После этого в списке версий удаляемый ключ будет помечен как запланированный на удаление (Scheduled For Destruction). Теперь этой версией ключа невозможно расшифровать файлы, которые были зашифрованы с её помощью.<br />Провести ротацию ключа можно и из командной строки. Для этого используется команда:<br />yc kms symmetric-key rotate &lt;ID ключа&gt; <br />Шаг 6<br />Зашифруйте исходный файл plain.txt с помощью новой версии ключа. Результат запишите в файл encrypted_with_new_key.txt.<br />yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted_with_new_key.txt <br />Теперь у вас есть два файла:<br />- encrypted.txt, зашифрованный версией ключа, которая помечена на удаление;<br />- encrypted_with_new_version.txt, зашифрованный новой версией ключа.<br />Попробуйте расшифровать данные из обоих файлов. Вы увидите, что расшифровать первый файл не получилось, а файл, который зашифрован второй версией ключа, расшифрован.<br />Запланированное удаление первой версии ключа можно отменить. Это позволит расшифровать данные из первого файла.<br />В строке версии ключа, которая запланирована на удаление, нажмите значок &hellip;, а затем кнопку кнопку Отменить удаление. Эта версия снова получит статус активной. Проверьте, что она работает, расшифровав файл encrypted.txt.<br /><strong>Decision:</strong><br />$ vim plain.txt<br />$ cat plain.txt<br />test text<br />$ yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted.txt<br />$ yc kms symmetric-crypto encrypt --id abjkh5a8k2uao3f8qi8k --plaintext-file plain.txt --ciphertext-file encrypted.txt<br />$ cat encrypted.txt <br />abj2vjcrv89d83cef26in#���k��|�V�X�<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ����:�F���*Y��l�(���у��֜�l�S<br />$ yc kms symmetric-crypto decrypt --id &lt;ID ключа&gt; --ciphertext-file encrypted.txt --plaintext-file decrypted.txt<br />$ cat decrypted.txt <br />test text<br />$ yc kms symmetric-key rotate &lt;ID ключа&gt;<br />$ yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted_with_new_key.txt<br />$ cat encrypted_with_new_key.txt<br />abjofv85g302tc8mjhqq��n�nߊz6�5�A�<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; �)ڀi�R0����o��s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; �^<br />�m�C zci�b�'</p>
